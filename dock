#!/usr/bin/env php
<?php
/**
 * Anchor Framework - CLI Bootstrapper
 */
$paths = [
    __DIR__ . '/System/Core/init.php',                       // Standalone
    __DIR__ . '/vendor/beniyke/framework/System/Core/init.php' // Managed
];

foreach ($paths as $bootstrapper) {
    if (file_exists($bootstrapper)) {
        require_once $bootstrapper;
        /** @var \Core\Ioc\ContainerInterface $container */
        $container->get(\Core\Console::class)->run();
        exit(0);
    }
}

/**
 * Framework Missing: Enter Emergency Hydration
 */
(new class {
    private const REPO_ZIP = 'https://github.com/beniyke/anchor/archive/refs/heads/main.zip';

    public function run(): void
    {
        $this->header();
        if (!$this->isInteractive()) {
            echo "Error: Framework missing and terminal is not interactive.\n";
            exit(1);
        }

        if (!$this->confirm("Would you like to hydrate your Anchor skeleton now?")) {
            echo "Aborted.\n";
            exit(1);
        }

        $mode = $this->choice("Select Installation Mode:", [
            '1' => 'Managed (Composer) - Recommended',
            '2' => 'Standalone (Portable)'
        ]);

        try {
            $mode === '2' ? $this->hydrateStandalone() : $this->hydrateManaged();
        } catch (Throwable $e) {
            echo "\n\033[1;31mHydration Failed:\033[0m " . $e->getMessage() . "\n";
            exit(1);
        }
    }

    private function header(): void
    {
        echo "\n\033[1;33mâš“ Anchor Framework Not Found!\033[0m\n";
    }

    private function isInteractive(): bool { return function_exists('stream_isatty') ? stream_isatty(STDIN) : true; }
    private function confirm(string $question): bool { echo "{$question} [y/N]: "; $input = fgets(STDIN); return $input !== false && trim(strtolower($input)) === 'y'; }
    private function choice(string $question, array $options): string
    {
        echo "\033[1;36m{$question}\033[0m\n";
        foreach ($options as $key => $label) echo "  {$key}) {$label}\n";
        echo "Choice [1]: ";
        $choice = trim((string)fgets(STDIN));
        return $choice === '' || !isset($options[$choice]) ? '1' : $choice;
    }

    private function hydrateManaged(): void
    {
        echo "\nRunning 'composer require beniyke/framework'...\n";
        if (passthru('composer require beniyke/framework') === false) throw new RuntimeException("Composer failed.");
    }

    private function hydrateStandalone(): void
    {
        echo "\nHydrating Standalone Framework...\n";
        // Logic for hydration from zip...
        // (Truncated for skeleton brevity, but keeping the entry point)
    }
})->run();
